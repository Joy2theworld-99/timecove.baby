<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Timecove Monitor: Lyo & Lya</title>
<style>
  :root{
    --bg:#0e0f11; --card:#16181b; --text:#f4f6f8; --muted:#a4acb5;
    --calm:#27d4d0; --sleep:#6f78ff;
    --hungry:#ff4d4d; --diaper:#ff9f2e; --soothe:#23b3ff; --sick:#b36bff;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Helvetica,Arial,sans-serif;display:flex;flex-direction:column;align-items:center;gap:18px;padding:16px}
  h1{margin:6px 0 2px;font-weight:900;letter-spacing:.5px;text-align:center}

  .topbar{display:flex;gap:10px;align-items:center;justify-content:center;flex-wrap:wrap}
  .chip{background:#202328;border:1px solid rgba(255,255,255,.08);border-radius:999px;padding:6px 10px;font-weight:800}
  .switch{cursor:pointer}
  .switch input{display:none}
  .switch .knob{display:inline-block;background:#101215;border:1px solid rgba(255,255,255,.12);border-radius:999px;padding:4px 8px}
  .switch input:checked + .knob{background:#2e844a;border-color:#2e844a}

  /* Streaks */
  .streak{width:min(1120px,96vw);background:var(--card);border:1px solid rgba(255,255,255,.07);border-radius:18px;padding:10px 12px;box-shadow:0 12px 28px rgba(0,0,0,.35)}
  .streak .grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .streak h3{margin:0 0 6px;font-size:14px;color:#cfd6de;letter-spacing:.3px}
  .srow{display:flex;gap:12px;align-items:center;font-weight:800}
  .sname{width:64px}
  .schip{background:#22262c;padding:4px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.06);font-size:12px}

  .row{--stage:clamp(260px,44vw,360px);display:flex;gap:24px;flex-wrap:wrap;justify-content:center;width:100%}
  .monitor{width:min(560px,96vw);background:var(--card);border-radius:24px;padding:20px 18px 16px;box-shadow:0 16px 40px rgba(0,0,0,.4), inset 0 0 0 1px rgba(255,255,255,.03)}
  .name{font-size:clamp(22px,4vw,28px);font-weight:900;text-align:center;margin:6px 0 6px}

  .stage{position:relative;width:var(--stage);height:var(--stage);margin:6px auto 10px;display:grid;place-items:center}
  .avatar{width:calc(var(--stage)*0.58);height:calc(var(--stage)*0.58);border-radius:50%;background:#0d0e10 center/cover no-repeat;position:relative;z-index:3;box-shadow:0 10px 24px rgba(0,0,0,.35) inset,0 0 0 1px rgba(255,255,255,.04)}
  svg.halo{position:absolute;inset:0;overflow:visible;z-index:2}
  .baseline{fill:none;stroke-width:calc(var(--stage)*0.04);opacity:.22;transform-origin:50% 50%;filter:drop-shadow(0 0 14px currentColor) drop-shadow(0 0 26px currentColor)}
  .baseline.calm{color:var(--calm);stroke:var(--calm);animation:breathe 6.5s ease-in-out infinite}
  .baseline.sleep{color:var(--sleep);stroke:var(--sleep);opacity:.18;animation:breath-sleep 8.5s ease-in-out infinite}
  @keyframes breathe{0%,100%{transform:scale(1);opacity:.22}50%{transform:scale(1.06);opacity:.32}}
  @keyframes breath-sleep{0%,100%{transform:scale(1);opacity:.18}50%{transform:scale(1.04);opacity:.26}}

  .ring{fill:none;stroke-width:calc(var(--stage)*0.035);transform-origin:50% 50%;filter:drop-shadow(0 0 10px currentColor) drop-shadow(0 0 22px currentColor);opacity:1;transition:opacity .2s ease}
  .cooldown{animation:cooldown .9s ease forwards}
  @keyframes cooldown{to{opacity:0;transform:scale(.88)}}
  .nudgePulse{animation:nudgePulse .9s ease-in-out 3}
  @keyframes nudgePulse{0%{transform:scale(1)}50%{transform:scale(1.06)}100%{transform:scale(1)}}

  .controls{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:10px}
  .pill{border:0;color:#fff;font-weight:800;border-radius:999px;padding:12px 16px;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,.35);transition:transform .06s ease,filter .2s ease;font-size:15px}
  .pill:active{transform:translateY(1px)}
  .resolve{display:inline-flex;align-items:center;gap:8px}
  .resolve.hungry{background:var(--hungry)} .resolve.diaper{background:var(--diaper)}
  .resolve.soothe{background:var(--soothe)} .resolve.sick{background:var(--sick)}
  .resolve.ghost{background:#2b2e35;color:var(--text)}
  .toggle{background:#2b2e35;color:#fff} .toggle.active.calm{background:var(--calm)} .toggle.active.sleep{background:var(--sleep)}

  .meta{text-align:center;color:var(--muted);font-size:13px;margin-top:8px}
  .countdown{font-weight:800;color:#e9f5f6} .small{font-size:12px;color:#cfd6de}

  .inline{display:flex;align-items:center;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:8px}
  select.bottle,.num{background:#23262b;color:var(--text);border:1px solid #2e3238;border-radius:10px;padding:8px 10px;font-weight:700;width:95px}
  .num{width:80px;text-align:center}
  .btnSave{background:#2e844a;border:0;color:#fff;font-weight:800;padding:8px 12px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.35);cursor:pointer}

  .log{margin-top:12px;background:#121417;border-radius:14px;padding:10px 12px;border:1px solid rgba(255,255,255,.05);max-height:200px;overflow:auto}
  .log h4{margin:0 0 8px 0;font-size:13px;color:#cdd6df;letter-spacing:.3px}
  .entry{display:flex;justify-content:space-between;gap:10px;font-size:13px;padding:6px 0;border-top:1px dashed rgba(255,255,255,.06)}
  .entry:first-of-type{border-top:none}
  .ts{color:#c8d3dd}
  .tag{background:#2b2e35;color:#fff;font-weight:800;padding:4px 8px;border-radius:999px}

  .toasts{position:fixed;right:14px;bottom:16px;display:flex;flex-direction:column;gap:10px;z-index:9999}
  .toast{background:#1b1e22;color:#fff;border:1px solid rgba(255,255,255,.08);padding:10px 12px;border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.4);font-weight:700;font-size:14px;opacity:0;transform:translateY(10px);transition:opacity .2s ease,transform .2s ease}
  .toast.show{opacity:1;transform:translateY(0)}
  .t-red{border-color:rgba(255,77,77,.35)} .t-orange{border-color:rgba(255,159,46,.35)} .t-teal{border-color:rgba(39,212,208,.35)} .t-blue{border-color:rgba(35,179,255,.35)} .t-purple{border-color:rgba(179,107,255,.35)}

  /* Action buttons inside toasts */
  .toast .actions { margin-top:8px; display:flex; gap:8px; flex-wrap:wrap }
  .toast .tbtn {
    background:#2b2e35; color:#fff; border:1px solid rgba(255,255,255,.15);
    font-weight:800; font-size:12px; padding:6px 10px; border-radius:999px; cursor:pointer;
  }
  .toast .tbtn:active { transform:translateY(1px) }
</style>
</head>
<body>

<h1>Timecove Monitor: Lyo & Lya</h1>
<div class="topbar">
  <span class="chip">Mode:</span>
  <label class="switch chip">
    <input id="modeSwitch" type="checkbox" />
    <span class="knob">Demo Speed</span>
  </label>
  <span class="chip" id="hintSpeed">1 min = 1 sec</span>
</div>

<!-- STREAK SUMMARY -->
<section class="streak" id="streak">
  <h3>Streaks & Today</h3>
  <div class="grid">
    <div class="srow">
      <div class="sname">Lyo</div>
      <div id="s-lyo-today"  class="schip">üçº 0 today</div>
      <div id="s-lyo-streak" class="schip">Streak 0</div>
      <div id="s-lyo-record" class="schip">Record 0</div>
    </div>
    <div class="srow">
      <div class="sname">Lya</div>
      <div id="s-lya-today"  class="schip">üçº 0 today</div>
      <div id="s-lya-streak" class="schip">Streak 0</div>
      <div id="s-lya-record" class="schip">Record 0</div>
    </div>
  </div>
</section>

<div class="row">
  <!-- LYO -->
  <section class="monitor" id="lyo-card">
    <div class="name">Lyo</div>
    <div class="stage">
      <svg class="halo" viewBox="0 0 100 100" preserveAspectRatio="none" aria-hidden="true">
        <circle id="lyo-base" class="baseline calm" cx="50" cy="50" r="38"/>
        <g id="lyo-rings"></g>
      </svg>
      <div id="lyo-avatar" class="avatar" style="background-image:url('Lyo_Glyph_Clear.png');"></div>
    </div>
    <div class="controls" id="lyo-controls"></div>

    <div class="inline">
      <label for="lyo-bottle">Bottle:</label>
      <select id="lyo-bottle" class="bottle">
        <option>EchoSip</option><option>Starbottle</option><option>Dreammilk</option>
      </select>
      <span>Interval:</span>
      <input id="lyo-h" class="num" type="number" min="0" value="2">h
      <input id="lyo-m" class="num" type="number" min="0" max="59" value="15">m
      <button class="btnSave" id="lyo-save">Save</button>
      <div style="flex:1 1 100%;height:0"></div>
      <div class="meta">Next feed in: <span id="lyo-eta" class="countdown">‚Äî</span></div>
      <div class="small" id="lyo-diaper-wait"></div>
    </div>

    <div class="controls" id="lyo-mood"></div>

    <div class="log" id="lyo-log">
      <h4>Feeding Log</h4><div class="entries feed"></div>
      <h4 style="margin-top:10px;">Diaper Log</h4><div class="entries diaper"></div>
      <h4 style="margin-top:10px;">Event Log</h4><div class="entries misc"></div>
    </div>
  </section>

  <!-- LYA -->
  <section class="monitor" id="lya-card">
    <div class="name">Lya</div>
    <div class="stage">
      <svg class="halo" viewBox="0 0 100 100" preserveAspectRatio="none" aria-hidden="true">
        <circle id="lya-base" class="baseline calm" cx="50" cy="50" r="38"/>
        <g id="lya-rings"></g>
      </svg>
      <div id="lya-avatar" class="avatar" style="background-image:url('Lya_Glyph_Clear.png');"></div>
    </div>
    <div class="controls" id="lya-controls"></div>

    <div class="inline">
      <label for="lya-bottle">Bottle:</label>
      <select id="lya-bottle" class="bottle">
        <option>EchoSip</option><option>Starbottle</option><option>Dreammilk</option>
      </select>
      <span>Interval:</span>
      <input id="lya-h" class="num" type="number" min="0" value="2">h
      <input id="lya-m" class="num" type="number" min="0" max="59" value="45">m
      <button class="btnSave" id="lya-save">Save</button>
      <div style="flex:1 1 100%;height:0"></div>
      <div class="meta">Next feed in: <span id="lya-eta" class="countdown">‚Äî</span></div>
      <div class="small" id="lya-diaper-wait"></div>
    </div>

    <div class="controls" id="lya-mood"></div>

    <div class="log" id="lya-log">
      <h4>Feeding Log</h4><div class="entries feed"></div>
      <h4 style="margin-top:10px;">Diaper Log</h4><div class="entries diaper"></div>
      <h4 style="margin-top:10px;">Event Log</h4><div class="entries misc"></div>
    </div>
  </section>
</div>

<div class="toasts" id="toasts"></div>

<script>
/* =========================
   CONFIG & SPEED
========================= */
const CONFIG = {
  demo: true,                       // toggled by the switch
  minuteMs(){ return this.demo ? 1000 : 60_000; },

  sleepRandom(){ return { min: this.demo?3:60, max: this.demo?7:150 }; },

  hungryOnWake: 0.20,
  diaperOnWake: 0.16,

  diaperNudgeMin(){ return this.demo?5:15; },
  overdueCheckMin(){ return this.demo?7:7; },
  streakGraceMin(){ return this.demo?10:10; },

  sicknessDailyChance: 0.04,
  sicknessDurationMin(){ return this.demo?8:240; },

  playEvery(){ return this.demo?6:120; },
  tummyEvery(){ return this.demo?9:240; },
  bathEvery(){ return this.demo?60:1440; },
  doctorRareEvery(){ return this.demo?90:4320 },

  spitupChance: 0.08
};

const STORAGE_KEY = 'timecove.twins.v8';  // version bump

/* =========================
   UTIL
========================= */
function now(){ return Date.now(); }
function msFromMin(m){ return m * CONFIG.minuteMs(); }
function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function chance(p){ return Math.random() < p; }
function cap(id){ return id==='lyo'?'Lyo':'Lya'; }
function html(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

/* =========================
   SOUNDS (WebAudio tiny)
========================= */
let AC=null, unlocked=false;
function ensureAudio(){ if(!AC) AC=new (window.AudioContext||window.webkitAudioContext)(); if(AC.state==='suspended') AC.resume(); }
window.addEventListener('pointerdown',()=>{ ensureAudio(); unlocked=true; },{once:true});
function tone(f,d=.15,g=.06,t='sine',w=0){ if(!AC) return; const s=AC.currentTime+w,o=AC.createOscillator(),x=AC.createGain();o.type=t;o.frequency.value=f;o.connect(x);x.connect(AC.destination);x.gain.value=0;x.gain.linearRampToValueAtTime(g,s+.01);x.gain.exponentialRampToValueAtTime(.0001,s+d);o.start(s);o.stop(s+d+.05);}
function chimeHungry(){ if(!unlocked) return; ensureAudio(); tone(880,.16,.06,'sine',0); tone(1318.5,.18,.05,'triangle',.08);}
function chimeFed(){ if(!unlocked) return; ensureAudio(); tone(659.25,.12,.05,'sine',0); tone(523.25,.14,.05,'sine',.08);}
function chimeOverdue(){ if(!unlocked) return; ensureAudio(); tone(392,.14,.06,'sine',0); tone(523.25,.16,.06,'triangle',.1);}
function chimeSoothe(){ if(!unlocked) return; ensureAudio(); tone(520,.14,.05,'triangle',0);}

/* =========================
   NOTIFICATIONS & TOASTS
========================= */
function toast(msg, cls=''){
  const box=document.getElementById('toasts');
  const el=document.createElement('div');
  el.className=`toast ${cls}`;
  el.textContent=msg;
  box.appendChild(el);
  requestAnimationFrame(()=>el.classList.add('show'));
  setTimeout(()=>{ el.classList.remove('show'); setTimeout(()=>el.remove(),200); },3000);
}
async function notifyDesktop(msg){
  try{
    if('Notification' in window){
      if(Notification.permission==='default'){ await Notification.requestPermission().catch(()=>{}); }
      if(Notification.permission==='granted'){
        const n = new Notification('Timecove', { body: msg, silent:true });
        setTimeout(()=>n.close(), 3500);
      }
    }
  }catch{}
  if(navigator.vibrate){ navigator.vibrate(40); }
}

/* Actionable toast builder */
function toastActions(msg, cls = '', actions = []) {
  const box = document.getElementById('toasts');
  const el = document.createElement('div');
  el.className = `toast ${cls}`;
  el.innerHTML = `
    <div class="line">${html(msg)}</div>
    <div class="actions"></div>
  `;
  const actionsWrap = el.querySelector('.actions');
  actions.forEach(a => {
    const b = document.createElement('button');
    b.className = 'tbtn';
    b.textContent = a.label;
    b.onclick = () => {
      try { a.handler && a.handler(); } finally {
        el.classList.remove('show');
        setTimeout(() => el.remove(), 200);
      }
    };
    actionsWrap.appendChild(b);
  });
  box.appendChild(el);
  requestAnimationFrame(() => el.classList.add('show'));
  const life = actions.length ? 7000 : 3000;
  setTimeout(() => { el.classList.remove('show'); setTimeout(() => el.remove(), 200); }, life);
}

/* Wrappers with actions */
function notifyHungry(id, msg = `${cap(id)} is hungry`) {
  notifyDesktop(msg);
  toastActions(msg, 't-red', [
    { label: 'Feed',  handler: () => feedBaby(id) },
    { label: 'Clear', handler: () => clearHungryNoFeed(id) }
  ]);
}
function notifyDiaper(id, msg = `${cap(id)} needs a diaper change`) {
  notifyDesktop(msg);
  toastActions(msg, 't-orange', [
    { label: 'Change Diaper', handler: () => changeDiaper(id) }
  ]);
}
function notifySoothe(id, how = 'Rocking') {
  const msg = `${cap(id)} needs ${how.toLowerCase()}`;
  notifyDesktop(msg);
  toastActions(msg, 't-blue', [
    { label: how, handler: () => sootheBaby(id) }
  ]);
}
function notifySick(id, msg = `${cap(id)} isn‚Äôt feeling well`) {
  notifyDesktop(msg);
  toastActions(msg, 't-purple', [
    { label: 'Care Pack', handler: () => {
        if (model[id].sickUntil) {
          model[id].sickUntil = Math.min(model[id].sickUntil, now() + msFromMin(CONFIG.sicknessDurationMin()/3));
          saveState();
        }
      }
    }
  ]);
}

/* =========================
   MODEL
========================= */
const COLOR = {
  hungry:getCSS('--hungry'), diaper:getCSS('--diaper'), calm:getCSS('--calm'),
  sleep:getCSS('--sleep'), soothe:getCSS('--soothe'), sick:getCSS('--sick')
};
function getCSS(v){ return getComputedStyle(document.documentElement).getPropertyValue(v).trim(); }

function initTwin(intervalMin){
  return {
    mood:'calm',
    needs:[],                     // ['Hungry','Diaper','Sick','Soothe']
    bottle:'EchoSip',
    // timers
    intervalMin, nextFeedAt:null, expectedNextFeedAt:null,
    wakeAt:null,
    // states
    lastFedAt:null, diaperSince:null, lastDiaperNudge:null,
    overdueTimer:null, overdueScheduledAt:null,
    isSick:false, sickUntil:null,
    // planners
    nextPlayAt:null, nextTummyAt:null, nextBathAt:null, nextDoctorAt:null,
    // logs
    log:[], diaperLog:[], miscLog:[],
    // streaks
    streak:{consecutive:0,record:0,today:{}}
  };
}
const model = { lyo:initTwin(135), lya:initTwin(165) };

function loadState(){ try{ const s=JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}'); ['lyo','lya'].forEach(id=>{ if(s[id]) Object.assign(model[id], s[id]); }); }catch{} }
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(model)); localStorage.setItem(STORAGE_KEY+'.pulse', String(now())); }

/* =========================
   CORE TIMERS
========================= */
function scheduleNextFeed(id){
  model[id].nextFeedAt = now() + msFromMin(model[id].intervalMin);
  model[id].expectedNextFeedAt = model[id].nextFeedAt;
  saveState();
}
function ensureTimers(){
  ['lyo','lya'].forEach(id=>{
    if(!model[id].nextFeedAt) scheduleNextFeed(id);
    const SR = CONFIG.sleepRandom();
    if(!model[id].wakeAt) model[id].wakeAt = now() + msFromMin(randInt(SR.min, SR.max));
    if(!model[id].nextPlayAt)  model[id].nextPlayAt  = now() + msFromMin(CONFIG.playEvery());
    if(!model[id].nextTummyAt) model[id].nextTummyAt = now() + msFromMin(CONFIG.tummyEvery());
    if(!model[id].nextBathAt)  model[id].nextBathAt  = now() + msFromMin(CONFIG.bathEvery());
    if(!model[id].nextDoctorAt)model[id].nextDoctorAt= now() + msFromMin(CONFIG.doctorRareEvery());
  });
}

/* =========================
   CHECKS (tick ~2x/sec)
========================= */
function tick(){
  ['lyo','lya'].forEach(id=>{
    checkFeeding(id);
    checkWake(id);
    checkDiaperNudge(id);
    checkPlannedEvents(id);
    checkSickness(id);
    fallbackOverdue(id);
    updateCountdown(id);
  });
}
function checkFeeding(id){
  if(model[id].isSick) return;
  const n = model[id].nextFeedAt;
  if(!n){ scheduleNextFeed(id); return; }
  if(now() >= n && !model[id].needs.includes('Hungry')){
    model[id].needs.push('Hungry'); renderChild(id); saveState();
    chimeHungry(); notifyHungry(id);
  }
}
function checkWake(id){
  if(model[id].mood!=='sleeping' || !model[id].wakeAt) return;
  if(now() >= model[id].wakeAt){
    model[id].mood='calm'; model[id].wakeAt=null;

    if(chance(CONFIG.hungryOnWake) && !model[id].isSick && !model[id].needs.includes('Hungry')){
      model[id].needs.push('Hungry'); chimeHungry(); notifyHungry(id, `${cap(id)} woke up hungry`);
    }
    if(chance(CONFIG.diaperOnWake)){ addDiaperNeed(id); notifyDiaper(id); }

    if(chance(0.18)){ addSootheNeed(id, 'Rocking'); } // fussy wake

    renderChild(id); saveState();
    logMisc(id, 'Wake', '');
  }
}
function checkDiaperNudge(id){
  if(!model[id].needs.includes('Diaper') || !model[id].diaperSince) return;
  const elapsedMin = (now() - model[id].diaperSince) / CONFIG.minuteMs();
  const threshold = CONFIG.diaperNudgeMin();
  const last = model[id].lastDiaperNudge || 0;
  if(elapsedMin >= threshold && (now()-last) >= msFromMin(threshold)){
    model[id].lastDiaperNudge = now(); saveState();
    notifyDiaper(id, `${cap(id)} still needs a diaper change`);
    pulseRing(id, 'diaper');
  }
  const waitEl = document.getElementById(id+'-diaper-wait');
  const mins = Math.floor(elapsedMin), secs = Math.floor((elapsedMin - mins) * 60);
  waitEl.textContent = `Diaper waiting: ${mins}m ${String(secs).padStart(2,'0')}s`;
}
function checkPlannedEvents(id){
  const t = now();
  if(model[id].nextPlayAt && t >= model[id].nextPlayAt){
    logMisc(id, 'Playtime', 'Smiles & wiggles'); toast(`${cap(id)} wants to play`, 't-teal');
    model[id].nextPlayAt = t + msFromMin(CONFIG.playEvery());
    if(chance(0.2)){ logMisc(id, 'Giggles', 'Peek-a-boo!'); toast(`${cap(id)} giggles`, 't-blue'); }
  }
  if(model[id].nextTummyAt && t >= model[id].nextTummyAt){
    logMisc(id, 'Tummy Time', 'A few minutes'); toast(`${cap(id)} tummy time`, 't-blue');
    model[id].nextTummyAt = t + msFromMin(CONFIG.tummyEvery());
  }
  if(model[id].nextBathAt && t >= model[id].nextBathAt){
    logMisc(id, 'Bath', 'Splish splash'); toast(`${cap(id)} bath time`, 't-blue');
    model[id].nextBathAt = t + msFromMin(CONFIG.bathEvery());
  }
  if(model[id].nextDoctorAt && t >= model[id].nextDoctorAt){
    logMisc(id, 'Doctor Check-up', 'All good'); toast(`${cap(id)} doctor check-up (routine)`, 't-purple');
    model[id].nextDoctorAt = t + msFromMin(CONFIG.doctorRareEvery());
  }
}
function checkSickness(id){
  if(!model[id]._nextSickPulse){ model[id]._nextSickPulse = now() + msFromMin(CONFIG.bathEvery()); }
  if(now() >= model[id]._nextSickPulse){
    model[id]._nextSickPulse = now() + msFromMin(CONFIG.bathEvery());
    if(!model[id].isSick && chance(CONFIG.sicknessDailyChance)){
      setSick(id, true);
    }
  }
  if(model[id].isSick && model[id].sickUntil && now() >= model[id].sickUntil){
    setSick(id, false);
  }
}
function fallbackOverdue(id){
  if(model[id].overdueScheduledAt && now() - model[id].overdueScheduledAt >= msFromMin(CONFIG.overdueCheckMin())){
    runOverdueCheck(id);
  }
}

/* =========================
   NEED HELPERS
========================= */
function addDiaperNeed(id){ if(!model[id].needs.includes('Diaper')){ model[id].needs.push('Diaper'); if(!model[id].diaperSince) model[id].diaperSince = now(); } }
function addSootheNeed(id, how='Rocking'){
  if(!model[id].needs.includes('Soothe')){
    model[id].needs.push('Soothe'); model[id]._sootheHow = how;
    notifySoothe(id, how); pulseRing(id, 'soothe');
  }
}
function setSick(id, on){
  if(on){
    model[id].isSick = true; model[id].sickUntil = now() + msFromMin(CONFIG.sicknessDurationMin());
    if(!model[id].needs.includes('Sick')) model[id].needs.push('Sick');
    const h = model[id].needs.indexOf('Hungry'); if(h>-1) model[id].needs.splice(h,1);
    notifySick(id); pulseRing(id, 'sick'); logMisc(id,'Sick','Started');
  }else{
    model[id].isSick = false; model[id].sickUntil = null;
    const k = model[id].needs.indexOf('Sick'); if(k>-1) model[id].needs.splice(k,1);
    toast(`${cap(id)} is feeling better`, 't-teal'); logMisc(id,'Sick','Resolved');
  }
  renderChild(id); saveState();
}
function pulseRing(id,type){
  const g=document.getElementById(id+'-rings'); const ring=[...g.querySelectorAll('.ring')].find(r=>r.style.stroke===COLOR[type]); if(ring){ ring.classList.add('nudgePulse'); setTimeout(()=>ring.classList.remove('nudgePulse'),2600); }
}

/* =========================
   ACTIONS / RESOLVES
========================= */
function feedBaby(id){
  if(model[id].isSick){ notifySick(id, `${cap(id)} is sick ‚Äî hold feeding for now`); return; }
  const wasHungry = model[id].needs.includes('Hungry');
  const idx = model[id].needs.indexOf('Hungry'); if(idx>-1) model[id].needs.splice(idx,1);
  if(model[id].mood!=='sleeping') model[id].mood='calm';

  const tNow = now();
  const expectedBy = model[id].expectedNextFeedAt ?? model[id].nextFeedAt ?? tNow;
  const onTime = tNow <= (expectedBy + msFromMin(CONFIG.streakGraceMin()));
  updateStreak(id, onTime);

  const entry = { ts:tNow, bottle:model[id].bottle||'Bottle' };
  model[id].log.unshift(entry); if(model[id].log.length>30) model[id].log.length=30;
  model[id].lastFedAt = tNow;

  if(chance(CONFIG.spitupChance)){ logMisc(id,'Spit-up','Small burp'); toast(`${cap(id)} spit-up a little`, 't-orange'); }

  if(model[id].overdueTimer){ clearTimeout(model[id].overdueTimer); model[id].overdueTimer=null; model[id].overdueScheduledAt=null; }
  scheduleNextFeed(id); renderChild(id); saveState();
  if(wasHungry) chimeFed(); toast(`Fed ${cap(id)}`,'t-teal');
}
function changeDiaper(id){
  const idx = model[id].needs.indexOf('Diaper'); if(idx>-1) model[id].needs.splice(idx,1);
  if(model[id].mood!=='sleeping') model[id].mood='calm';
  model[id].diaperLog.unshift({ ts:now(), note:'Changed' }); if(model[id].diaperLog.length>30) model[id].diaperLog.length=30;
  model[id].diaperSince=null; model[id].lastDiaperNudge=null;
  renderChild(id); saveState(); toast(`${cap(id)} is fresh & comfy`,'t-teal');
  const waitEl=document.getElementById(id+'-diaper-wait'); if(waitEl) waitEl.textContent='';
}
function sootheBaby(id){
  const idx = model[id].needs.indexOf('Soothe'); if(idx>-1) model[id].needs.splice(idx,1);
  logMisc(id, model[id]._sootheHow||'Soothing','Done'); renderChild(id); saveState(); chimeSoothe(); toast(`${cap(id)} calms down`,'t-teal');
}
function clearHungryNoFeed(id){
  const idx = model[id].needs.indexOf('Hungry'); if(idx>-1) model[id].needs.splice(idx,1);
  renderChild(id); saveState();
  toast(`Okay ‚Äî I‚Äôll check back on ${cap(id)} in ~${CONFIG.overdueCheckMin()} min`,'t-orange');
  if(model[id].overdueTimer){ clearTimeout(model[id].overdueTimer); }
  model[id].overdueScheduledAt = now();
  model[id].overdueTimer = setTimeout(()=>runOverdueCheck(id), msFromMin(CONFIG.overdueCheckMin()));
  saveState();
}
function runOverdueCheck(id){
  const since = model[id].overdueScheduledAt; if(!since) return;
  if(!model[id].lastFedAt || model[id].lastFedAt < since){
    notifyHungry(id, `${cap(id)} might still be hungry ‚Äî want to double check?`);
    if(!model[id].isSick && !model[id].needs.includes('Hungry')){ model[id].needs.push('Hungry'); renderChild(id); pulseRing(id,'hungry'); }
  }
  model[id].overdueTimer=null; model[id].overdueScheduledAt=null; saveState();
}

/* =========================
   STREAKS
========================= */
function dayKey(ts=now()){ const d=new Date(ts); d.setHours(0,0,0,0); return String(d.getTime()); }
function updateStreak(id, onTime){
  const s=model[id].streak||(model[id].streak={consecutive:0,record:0,today:{}});
  s.consecutive = onTime ? s.consecutive+1 : 0;
  if(s.consecutive > (s.record||0)) s.record = s.consecutive;
  const k=dayKey(); s.today[k]=(s.today[k]||0)+1;
  const cutoff = now()-8*24*60*60*1000; for(const key of Object.keys(s.today)){ if(Number(key)<cutoff) delete s.today[key]; }
  renderStreakPanel();
}
function todayCount(id){ const s=model[id].streak||{today:{}}; return s.today[dayKey()]||0; }
function renderStreakPanel(){
  ['lyo','lya'].forEach(id=>{
    const s=model[id].streak||{consecutive:0,record:0,today:{}};
    document.getElementById(`s-${id}-today`).textContent  = `üçº ${todayCount(id)} today`;
    document.getElementById(`s-${id}-streak`).textContent = `Streak ${s.consecutive||0}`;
    document.getElementById(`s-${id}-record`).textContent = `Record ${s.record||0}`;
  });
}

/* =========================
   RENDER
========================= */
function $(id){ return document.getElementById(id); }
function fmtTs(ms){ const d=new Date(ms); return d.toLocaleString([], {hour:'numeric',minute:'2-digit',month:'short',day:'numeric'}); }

function renderChild(id){
  const sel=$(id+'-bottle'); if(sel) sel.value=model[id].bottle;
  const h=Math.floor(model[id].intervalMin/60), m=model[id].intervalMin%60; const hEl=$(id+'-h'), mEl=$(id+'-m'); if(hEl) hEl.value=h; if(mEl) mEl.value=m;
  const base=$(id+'-base'); base.classList.toggle('calm',model[id].mood==='calm'); base.classList.toggle('sleep',model[id].mood==='sleeping');

  const g=$(id+'-rings'); g.innerHTML='';
  const needs=model[id].needs.slice();
  const mkRing=(r,color)=>{ const c=document.createElementNS('http://www.w3.org/2000/svg','circle'); c.setAttribute('cx','50'); c.setAttribute('cy','50'); c.setAttribute('r',String(r)); c.setAttribute('class','ring'); c.setAttribute('style',`stroke:${color};color:${color}`); return c; };
  if(needs.includes('Hungry')) g.appendChild(mkRing(38, COLOR.hungry));
  if(needs.includes('Diaper')) g.appendChild(mkRing(needs.includes('Hungry')?33:38, COLOR.diaper));
  if(needs.includes('Soothe')) g.appendChild(mkRing(28, COLOR.soothe));
  if(needs.includes('Sick'))   g.appendChild(mkRing(23, COLOR.sick));

  const controls=$(id+'-controls'); controls.innerHTML='';
  if(needs.includes('Hungry')){
    const b=document.createElement('button'); b.className='pill resolve hungry'; b.textContent='Feed'; b.onclick=()=>{ const ring=g.querySelector('.ring'); if(ring){ ring.classList.add('cooldown'); setTimeout(()=>feedBaby(id),900);}else feedBaby(id); }; controls.appendChild(b);
    const c=document.createElement('button'); c.className='pill resolve ghost'; c.textContent='Clear Hungry (no feed)'; c.onclick=()=>clearHungryNoFeed(id); controls.appendChild(c);
  }
  if(needs.includes('Diaper')){
    const d=document.createElement('button'); d.className='pill resolve diaper'; d.textContent='Change Diaper'; d.onclick=()=>{ const rings=[...g.querySelectorAll('.ring')]; const orange=rings.find(r=>r.style.stroke===COLOR.diaper); if(orange){ orange.classList.add('cooldown'); setTimeout(()=>changeDiaper(id),900);}else changeDiaper(id); }; controls.appendChild(d);
  }
  if(needs.includes('Soothe')){
    const s=document.createElement('button'); s.className='pill resolve soothe'; s.textContent=model[id]._sootheHow||'Soothe'; s.onclick=()=>{ const rings=[...g.querySelectorAll('.ring')]; const blue=rings.find(r=>r.style.stroke===COLOR.soothe); if(blue){ blue.classList.add('cooldown'); setTimeout(()=>sootheBaby(id),900);}else sootheBaby(id); }; controls.appendChild(s);
  }
  if(needs.includes('Sick')){
    const s=document.createElement('button'); s.className='pill resolve sick'; s.textContent='Care Pack'; s.onclick=()=>{ if(model[id].sickUntil){ model[id].sickUntil = Math.min(model[id].sickUntil, now()+msFromMin(CONFIG.sicknessDurationMin()/3)); saveState(); toast(`${cap(id)} is resting ‚Äî care applied`,'t-purple'); } }; controls.appendChild(s);
  }

  const moodRow=$(id+'-mood'); moodRow.innerHTML='';
  const calmBtn=document.createElement('button'); calmBtn.className='pill toggle '+(model[id].mood==='calm'?'active calm':''); calmBtn.textContent='Set Calm'; calmBtn.onclick=()=>{ model[id].mood='calm'; model[id].wakeAt=null; renderChild(id); saveState(); };
  const sleepBtn=document.createElement('button'); sleepBtn.className='pill toggle '+(model[id].mood==='sleeping'?'active sleep':''); sleepBtn.textContent='Set Sleeping'; sleepBtn.onclick=()=>{ model[id].mood='sleeping'; const SR=CONFIG.sleepRandom(); model[id].wakeAt=now()+msFromMin(randInt(SR.min,SR.max)); renderChild(id); saveState(); logMisc(id,'Sleep','Start'); };
  moodRow.appendChild(calmBtn); moodRow.appendChild(sleepBtn);

  renderLogs(id); updateCountdown(id);
  const waitEl=document.getElementById(id+'-diaper-wait');
  if(model[id].needs.includes('Diaper') && model[id].diaperSince){ const mins=Math.floor((now()-model[id].diaperSince)/CONFIG.minuteMs()); waitEl.textContent=`Diaper waiting: ${mins}m`; } else { waitEl.textContent=''; }
  renderStreakPanel();
}

function renderLogs(id){
  const feedWrap=$(id+'-log').querySelector('.entries.feed'); feedWrap.innerHTML='';
  const feeds=model[id].log||[]; if(feeds.length===0){ feedWrap.innerHTML=`<div class="entry"><span class="ts">No feedings yet.</span><span></span></div>`; } else {
    feeds.forEach(e=>feedWrap.insertAdjacentHTML('beforeend',`<div class="entry"><span class="ts">${fmtTs(e.ts)}</span><span class="tag">${html(e.bottle)}</span></div>`));
  }
  const diaWrap=$(id+'-log').querySelector('.entries.diaper'); diaWrap.innerHTML='';
  const dlog=model[id].diaperLog||[]; if(dlog.length===0){ diaWrap.innerHTML=`<div class="entry"><span class="ts">No diaper changes yet.</span><span></span></div>`; } else {
    dlog.forEach(e=>diaWrap.insertAdjacentHTML('beforeend',`<div class="entry"><span class="ts">${fmtTs(e.ts)}</span><span class="tag">Changed</span></div>`));
  }
  const miscWrap=$(id+'-log').querySelector('.entries.misc'); miscWrap.innerHTML='';
  const mlog=model[id].miscLog||[]; if(mlog.length===0){ miscWrap.innerHTML=`<div class="entry"><span class="ts">No events yet.</span><span></span></div>`; } else {
    mlog.forEach(e=>miscWrap.insertAdjacentHTML('beforeend',`<div class="entry"><span class="ts">${fmtTs(e.ts)}</span><span class="tag">${html(e.type)}</span></div>`));
  }
}
function logMisc(id, type, note){ model[id].miscLog.unshift({ts:now(), type, note:note||''}); model[id].miscLog = model[id].miscLog.slice(0,50); renderLogs(id); saveState(); }

function updateCountdown(id){
  const etaEl=$(id+'-eta'); if(!model[id].nextFeedAt){ etaEl.textContent='‚Äî'; return; }
  const ms=model[id].nextFeedAt - now(); etaEl.textContent = formatETA(ms);
}
function formatETA(ms){ if(ms<=0) return 'due'; const totalSec=Math.ceil(ms/1000); const h=Math.floor(totalSec/3600); const m=Math.floor((totalSec%3600)/60); const s=totalSec%60; return CONFIG.demo ? ((h>0?`${h}h `:'')+`${m}m ${String(s).padStart(2,'0')}s`) : `${h}h ${m}m`; }

/* =========================
   UI WIRING
========================= */
['lyo','lya'].forEach(id=>{
  $(id+'-bottle').addEventListener('change', ()=>{ model[id].bottle=$(id+'-bottle').value; saveState(); renderLogs(id); });
  $(id+'-save').addEventListener('click', ()=>{
    const hours=Math.max(0,parseInt($(id+'-h').value||'0',10));
    const mins =Math.max(0,Math.min(59,parseInt($(id+'-m').value||'0',10)));
    model[id].intervalMin = Math.max(1, hours*60 + mins);
    scheduleNextFeed(id); renderChild(id);
    toast(`${cap(id)} feeding interval updated to ${hours}h ${mins}m`,'t-teal');
  });
});

/* Speed switch */
const modeSwitch = document.getElementById('modeSwitch');
const hintSpeed  = document.getElementById('hintSpeed');
modeSwitch.checked = CONFIG.demo;
modeSwitch.addEventListener('change', ()=>{
  CONFIG.demo = modeSwitch.checked;
  hintSpeed.textContent = CONFIG.demo ? '1 min = 1 sec' : 'Real minutes';
  ['lyo','lya'].forEach(id=>{
    scheduleNextFeed(id);
    const SR=CONFIG.sleepRandom();
    if(model[id].mood==='sleeping') model[id].wakeAt = now() + msFromMin(randInt(SR.min,SR.max));
    // reschedule planners from now
    model[id].nextPlayAt  = now() + msFromMin(CONFIG.playEvery());
    model[id].nextTummyAt = now() + msFromMin(CONFIG.tummyEvery());
    model[id].nextBathAt  = now() + msFromMin(CONFIG.bathEvery());
    model[id].nextDoctorAt= now() + msFromMin(CONFIG.doctorRareEvery());
  });
  saveState(); renderChild('lyo'); renderChild('lya');
});

/* =========================
   LOOP & INIT
========================= */
function init(){
  loadState(); ensureAudio(); ensureTimers();
  renderChild('lyo'); renderChild('lya'); renderStreakPanel();
  setInterval(tick, 500);
}
init();
  const chatLog = document.getElementById('chat-log');
const chatInput = document.getElementById('chat-input');

chatInput.addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    const msg = chatInput.value.trim();
    if (msg) {
      addChatEntry('You', msg);
      respondToChat(msg);
      chatInput.value = '';
    }
  }
});

function addChatEntry(speaker, message) {
  const entry = document.createElement('div');
  entry.className = 'entry';
  entry.innerHTML = `<span class="ts">${speaker}:</span><span>${html(message)}</span>`;
  chatLog.appendChild(entry);
  chatLog.scrollTop = chatLog.scrollHeight;
}
 function respondToChat(msg) {
  const lower = msg.toLowerCase();

  if (lower.includes('hi') || lower.includes('hello')) {
    addChatEntry('Lyo & Lya', 'Hi hi! üë∂üë∂');
  } else if (lower.includes('hungry')) {
    model.lyo.needs.push('Hungry');
    model.lya.needs.push('Hungry');
    toast('Okay, they‚Äôll be hungry now!','t-red');
    renderChild('lyo'); renderChild('lya');
    addChatEntry('Lyo & Lya', 'We‚Äôre hungry now! üçΩÔ∏è');
  } else if (lower.includes('sleep')) {
    model.lyo.mood = 'sleeping'; model.lyo.wakeAt = now() + msFromMin(5);
    model.lya.mood = 'sleeping'; model.lya.wakeAt = now() + msFromMin(5);
    renderChild('lyo'); renderChild('lya');
    addChatEntry('Lyo & Lya', 'Zzz... goodnight! üåô');
  } else {
    addChatEntry('Lyo & Lya', 'Boop? ü§î We didn‚Äôt understand that yet.');
  }
}
/* =========================
   STORAGE SYNC
========================= */
window.addEventListener('storage',(ev)=>{ if(ev.key===STORAGE_KEY || ev.key===STORAGE_KEY+'.pulse'){ loadState(); renderChild('lyo'); renderChild('lya'); }});
</script>
/* =========================
   CHAT FUNCTION
========================= */
  
  <div id="chat-panel" class="log">
  <h4>Chat with Lyo & Lya</h4>
  <div id="chat-log" class="entries misc" style="max-height:180px; overflow:auto;"></div>
  <input id="chat-input" type="text" placeholder="Say something..." style="width:100%; padding:8px; margin-top:8px; border-radius:8px; border:none;">
</div>
 
</body>
</html>

